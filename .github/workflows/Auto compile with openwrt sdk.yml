#
# Copyright (c) 2022-2023 SMALLPROGRAM <https://github.com/smallprogram>
# Description: Auto compile - Optimized & Enhanced
#
name: "Auto compile with openwrt sdk"
on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.0.0) - leave empty to auto-detect from Makefile'
        required: false
        default: ''
      release_type:
        description: 'Release Type'
        required: true
        default: 'stable'
        type: choice
        options:
          - stable
          - beta
      build_scope:
        description: 'Which platforms to build?'
        required: true
        default: 'all'
        type: choice
        options:
          - all          # All 18 platforms
          - popular      # Only x86_64, aarch64_generic, arm_cortex-a9
          - x86_only     # Only x86_64 (fastest for testing)
          - custom       # Use platform_filter input
          - none         # Skip all platform builds
      platform_filter:
        description: 'Custom platform filter (regex pattern, e.g., "x86|aarch64")'
        required: false
        default: ''
      package_format:
        description: 'Package format to build'
        required: true
        default: 'both'
        type: choice
        options:
          - both   # Build both IPK and APK
          - ipk    # Build IPK only
          - apk    # Build APK only
      enable_cache:
        description: 'Use caching to speed up builds?'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'
env:
  TZ: Asia/Shanghai
  passwall2: ${{ github.repository }}
  packages: Openwrt-Passwall/openwrt-passwall-packages
  package_names: "chinadns-ng geoview hysteria naiveproxy tcping tuic-client shadowsocks-rust shadowsocksr-libev simple-obfs sing-box v2ray-geodata v2ray-plugin xray-core"
  package_release: "chinadns-ng geoview hysteria naiveproxy tcping tuic-client shadowsocks-rust shadowsocksr-libev simple-obfs sing-box v2ray-geoip v2ray-geosite v2ray-plugin xray-core"
  CACHE_ENABLED: ${{ github.event.inputs.enable_cache || 'true' }}

permissions:
  contents: write
  actions: write

jobs:
  job_check:
    name: Check Version
    runs-on: ubuntu-latest
    outputs:
      passwall2_version: ${{ steps.check_version.outputs.latest_version }}
      has_update: ${{ steps.check_version.outputs.has_update }}
      prerelease: ${{ steps.check_version.outputs.prerelease }}
      build_all_platforms: ${{ steps.check_version.outputs.build_all_platforms }}
      build_scope: ${{ steps.check_version.outputs.build_scope }}
      release_type: ${{ steps.check_version.outputs.release_type }}
    steps:
      - name: Checkout
        uses: actions/checkout@main
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}

      - name: Check version
        id: check_version
        env:
          url_tags: https://api.github.com/repos/${{ env.passwall2 }}/releases/latest
        run: |
          cd luci-app-passwall2
          # Get release_type input (defaults to 'stable' for repository_dispatch or empty)
          release_type="${{ github.event.inputs.release_type }}"
          if [ -z "$release_type" ]; then
            release_type="stable"
          fi
          
          # Check if version is provided via input, otherwise auto-detect from Makefile
          if [ -n "${{ github.event.inputs.version }}" ]; then
            latest_version="${{ github.event.inputs.version }}"
            echo "Using manually specified version: $latest_version"
          else
            latest_version=$(awk -F ':=' '/^PKG_VERSION:=|^PKG_RELEASE:=/ {print $2}' Makefile | sed ':a;N;s/\$(PKG_VERSION)-//;s/\n$//;s/\n/-/;ba')
            echo "Auto-detected version from Makefile: $latest_version"
          fi
          
          # Append -beta suffix if release type is beta
          if [ "$release_type" == "beta" ]; then
            latest_version="${latest_version}-beta"
          fi
          echo "latest_version=${latest_version}" >> $GITHUB_OUTPUT

          # Set prerelease flag based on release_type
          if [ "$release_type" == "beta" ]; then
            prerelease=true
          else
            prerelease=$([ "${{ github.ref_name }}" == "main" ] && echo false || echo true)
          fi
          echo "prerelease=${prerelease}" >> $GITHUB_OUTPUT
          echo "release_type=${release_type}" >> $GITHUB_OUTPUT
          
          # Determine build scope
          build_scope="${{ github.event.inputs.build_scope }}"
          if [ -z "$build_scope" ]; then
            build_scope="all"
          fi
          echo "build_scope=${build_scope}" >> $GITHUB_OUTPUT
          
          # For popular/x86_only, we still want job_auto_compile to run
          # We'll filter in the matrix instead
          if [ "$build_scope" == "all" ]; then
            echo "build_all_platforms=true" >> $GITHUB_OUTPUT
          else
            echo "build_all_platforms=false" >> $GITHUB_OUTPUT
          fi

          remote_latest_version=$(wget -qO- -t1 -T2 ${{env.url_tags}} | jq -r '.tag_name')

          if [ -z "$remote_latest_version" ] || [ "$remote_latest_version" = "null" ]; then
            echo "Failed to fetch remote tags"
            echo "has_update=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "Remote latest: $remote_latest_version"

          if [ "$latest_version" = "$remote_latest_version" ]; then
            echo "has_update=false" >> $GITHUB_OUTPUT
          else
            echo "has_update=true" >> $GITHUB_OUTPUT
          fi

      - name: Prepare release
        if: steps.check_version.outputs.has_update == 'true'
        run: |
          echo "## :mega:Update content" >> release.txt
          if [ "${{ steps.check_version.outputs.release_type }}" == "beta" ]; then
            echo "> [!WARNING]" >> release.txt
            echo "> **This is a BETA release** - Use for testing only, not recommended for daily usage." >> release.txt
            echo "" >> release.txt
          fi
          echo "![](https://img.shields.io/github/downloads/${{ env.passwall2 }}/${{steps.check_version.outputs.latest_version}}/total?style=flat-square)" >> release.txt
          echo "### Passwall2 Info" >> release.txt
          echo "**:minidisc: Passwall2 Version: ${{steps.check_version.outputs.latest_version}}**" >> release.txt
          echo "**:gear: Build Scope: ${{steps.check_version.outputs.build_scope}}**" >> release.txt
          touch release.txt

      - name: Generate new tag & release
        if: steps.check_version.outputs.has_update == 'true'
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{steps.check_version.outputs.latest_version}}
          target_commitish: ${{ github.ref_name }}
          prerelease: ${{steps.check_version.outputs.prerelease}}
          body_path: release.txt


  job_build_passwall2:
    name: Build passwall2 [${{ matrix.ver }}]
    needs: job_check
    if: needs.job_check.outputs.has_update == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - ver: "ipk"
          - ver: "apk"
    steps:
      - name: Check if should build this format
        id: should_build_format
        run: |
          format_filter="${{ github.event.inputs.package_format }}"
          current_format="${{ matrix.ver }}"
          
          # Default to 'both' if empty (repository_dispatch)
          if [ -z "$format_filter" ]; then
            format_filter="both"
          fi
          
          should_build="true"
          
          # Check if this format should be built
          if [ "$format_filter" == "ipk" ] && [ "$current_format" == "apk" ]; then
            should_build="false"
            echo "Skipping APK - only IPK selected"
          elif [ "$format_filter" == "apk" ] && [ "$current_format" == "ipk" ]; then
            should_build="false"
            echo "Skipping IPK - only APK selected"
          else
            echo "Building $current_format (filter: $format_filter)"
          fi
          
          echo "should_build=$should_build" >> $GITHUB_OUTPUT

      - name: Checkout
        if: steps.should_build_format.outputs.should_build == 'true'
        uses: actions/checkout@main
        with:
          fetch-depth: 1

      - name: Install packages
        if: steps.should_build_format.outputs.should_build == 'true'
        run: |
          sudo -E rm -rf /usr/share/dotnet /etc/mysql /etc/php /usr/local/lib/android
          echo "Install packages"
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache clang cmake cpio curl device-tree-compiler ecj fastjar flex gawk gettext gcc-multilib \
            g++-multilib git gnutls-dev gperf haveged help2man intltool lib32gcc-s1 libc6-dev-i386 libelf-dev \
            libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses-dev libpython3-dev \
            libreadline-dev libssl-dev libtool libyaml-dev libz-dev lld llvm lrzsz mkisofs msmtp nano \
            ninja-build p7zip p7zip-full patch pkgconf python3 python3-pip python3-ply python3-docutils \
            python3-pyelftools qemu-utils re2c rsync scons squashfs-tools subversion swig texinfo uglifyjs \
            upx-ucl unzip vim wget xmlto xxd zlib1g-dev zstd
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean

      - name: Cache OpenWrt SDK
        if: env.CACHE_ENABLED == 'true' && steps.should_build_format.outputs.should_build == 'true'
        id: cache-sdk
        uses: actions/cache@v4
        with:
          path: |
            sdk
            !sdk/dl
            !sdk/tmp
          key: openwrt-sdk-x86_64-${{ matrix.ver }}-v1
          restore-keys: |
            openwrt-sdk-x86_64-${{ matrix.ver }}-

      - name: Initialization environment
        if: steps.cache-sdk.outputs.cache-hit != 'true' && steps.should_build_format.outputs.should_build == 'true'
        run: |
          url_sdk="https://downloads.openwrt.org/snapshots/targets/x86/64/openwrt-sdk-x86-64_gcc-14.3.0_musl.Linux-x86_64.tar.zst"
          wget --continue --progress=dot:giga $url_sdk || wget $url_sdk
          file_name=$(echo $url_sdk | awk -F/ '{print $NF}')
          mkdir -p sdk
          if [[ $file_name == *.tar.xz ]]; then
            tar -xJf $file_name -C ./sdk --strip-components=1
          elif [[ $file_name == *.tar.zst ]]; then
            tar --zstd -x -f $file_name -C ./sdk --strip-components=1
          else
            echo "Unsupported file format: $file_name"
            exit 1
          fi

      - name: Update SDK feeds
        if: steps.should_build_format.outputs.should_build == 'true'
        run: |
          cd sdk

          # Update feeds to github source
          sed -i \
              -e 's|git\.openwrt\.org/feed|github.com/openwrt|g' \
              -e 's|git\.openwrt\.org/project|github.com/openwrt|g' \
              -e 's|git\.openwrt\.org/openwrt|github.com/openwrt|g' \
              "feeds.conf.default"

          # Remove existing passwall feeds to avoid duplicates (from cache)
          sed -i '/passwall_packages/d' feeds.conf.default
          sed -i '/passwall2/d' feeds.conf.default

          # Add passwall feeds at the beginning
          cat > feeds.tmp <<'EOF'
          src-git passwall_packages https://github.com/Openwrt-Passwall/openwrt-passwall-packages.git;main
          src-git passwall2 https://github.com/${{ env.passwall2 }}.git;${{ github.ref_name }}
          EOF
          cat feeds.conf.default >> feeds.tmp
          mv feeds.tmp feeds.conf.default

          echo "=== Final feeds.conf.default ==="
          cat feeds.conf.default
          echo "==================================="

          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Update package version
        if: github.event.inputs.version != ''
        run: |
          cd sdk/feeds/passwall2/luci-app-passwall2
          version="${{ github.event.inputs.version }}"
          echo "Updating package version to: $version"
          
          # Extract version and release from input
          # Format could be "1.0.0" or "1.0.0-1" or "1.0.0-beta"
          if [[ "$version" == *-beta ]]; then
            # Remove -beta suffix for Makefile, we'll add it back in release
            version="${version%-beta}"
          fi
          
          if [[ "$version" == *-* ]]; then
            pkg_version="${version%-*}"
            pkg_release="${version##*-}"
          else
            pkg_version="$version"
            pkg_release="1"
          fi
          
          echo "PKG_VERSION=$pkg_version, PKG_RELEASE=$pkg_release"
          
          # Update Makefile
          sed -i "s/^PKG_VERSION:=.*/PKG_VERSION:=$pkg_version/" Makefile
          sed -i "s/^PKG_RELEASE:=.*/PKG_RELEASE:=$pkg_release/" Makefile
          
          echo "Updated Makefile:"
          grep -E "^PKG_VERSION|^PKG_RELEASE" Makefile

      - name: Apply patches
        if: steps.should_build_format.outputs.should_build == 'true'
        run: |
          cd sdk
          #--------------------------------------begin_patches------------------------------------------
          echo "Start applying the patch"

          rm -rf temp_resp
          git clone -b master --depth=1 --single-branch https://github.com/openwrt/packages.git temp_resp

          #--------------------------------------Update Golang------------------------------------------
          echo "update golang version"
          rm -rf feeds/packages/lang/golang
          cp -r temp_resp/lang/golang feeds/packages/lang

          #--------------------------------------Get latest Golang version------------------------------------------
          echo "Attempting to update Golang version..."
          wget https://go.dev/dl/?mode=json -O /tmp/golang.json
          go_latest_version=$(cat /tmp/golang.json | jq -r '.[0].version')
          GO_VERSION_MAJOR_MINOR=$(echo $go_latest_version | sed 's#go##' | awk -F '.' '{print $1 "." $2}')
          GO_VERSION_PATCH=$(echo $go_latest_version | sed 's#go##' | awk -F '.' '{print $3}')
          go_latest_version_hash=$(cat /tmp/golang.json | jq -r '.[0].files[0].sha256')
          
          # Find the correct golang directory with Makefile
          GOLANG_DIR=""
          for dir in $(find feeds/packages/lang/golang -type d -name "golang*" | sort); do
            if [ -f "$dir/Makefile" ]; then
              GOLANG_DIR="$dir"
              break
            fi
          done
          
          if [ -z "$GOLANG_DIR" ]; then
            echo "Warning: Could not find golang directory with Makefile, skipping Golang update"
          else
            echo "Found golang directory with Makefile: $GOLANG_DIR"
            sed -i -e "s/^GO_VERSION_MAJOR_MINOR:=.*/GO_VERSION_MAJOR_MINOR:=${GO_VERSION_MAJOR_MINOR}/" \
                   -e "s/^GO_VERSION_PATCH:=.*/GO_VERSION_PATCH:=${GO_VERSION_PATCH}/" \
                   -e "s/^PKG_HASH:=.*/PKG_HASH:=${go_latest_version_hash}/" "$GOLANG_DIR/Makefile" \
            && echo "Successfully updated Golang" || echo "Warning: Failed to update Golang"
          fi

          #--------------------------------------Update Rust------------------------------------------
          echo "update rust version"
          rm -rf feeds/packages/lang/rust
          cp -r temp_resp/lang/rust feeds/packages/lang

          #--------------------------------------Clean Temp------------------------------------------
          rm -rf temp_resp

          echo "update patch-kernel.sh"
          git clone -b main --depth=1 --single-branch https://github.com/openwrt/openwrt.git temp_resp
          cp -f temp_resp/scripts/patch-kernel.sh scripts/
          rm -rf temp_resp

          echo "Patch application completed"
          #--------------------------------------end_patches--------------------------------------------

      - name: Compile passwall2
        if: steps.should_build_format.outputs.should_build == 'true'
        id: compile
        run: |
          cd sdk
          ver=${{ matrix.ver }}
          if [ "$ver" == "ipk" ]; then
            # Disable APK if building IPK format (handle gracefully if Config-build.in missing/different)
            if [ -f "Config-build.in" ] && grep -q "USE_APK" Config-build.in 2>/dev/null; then
              config_apk_line=$(grep -n "USE_APK" Config-build.in | head -1 | awk -F ':' '{print $1}')
              if [ -n "$config_apk_line" ]; then
                check_line=$((config_apk_line + 2))
                if sed -n "${check_line}p" Config-build.in 2>/dev/null | grep -q "default y"; then
                  sed -i "${check_line}s/y/n/" Config-build.in
                  echo "Disabled APK for IPK build"
                fi
              fi
            fi
          fi
          echo "CONFIG_ALL_NONSHARED=n" > .config
          echo "CONFIG_ALL_KMODS=n" >> .config
          echo "CONFIG_ALL=n" >> .config
          echo "CONFIG_AUTOREMOVE=n" >> .config
          echo "CONFIG_LUCI_LANG_zh_Hans=y" >> .config
          echo "CONFIG_LUCI_LANG_zh_Hant=y" >> .config
          echo "CONFIG_LUCI_LANG_fa=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-passwall2=m" >> .config
          make defconfig
          # AFTER defconfig, forcefully disable all kernel packages (defconfig may re-enable them via deps)
          sed -i  '/^CONFIG_PACKAGE_kernel=/s/^CONFIG_\(.*\)=.*/# CONFIG_\1 is not set/' .config
          sed -i '/^CONFIG_PACKAGE_kmod-/s/^CONFIG_\(.*\)=.*/# CONFIG_\1 is not set/' .config
          echo "make package/luci-app-passwall2/{clean,compile} -j$(nproc)"
          make package/luci-app-passwall2/{clean,compile} -j$(nproc) V=s || make package/luci-app-passwall2/{clean,compile} -j1 V=s
          mkdir upload
          mv bin/packages/*/passwall2/luci-* upload/
          make clean
          cd upload
          echo "status=success" >> $GITHUB_OUTPUT
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV

      - name: Generate build report
        if: always()  # Run even if compile failed
        run: |
          REPORT_FILE="build_report_${{ matrix.ver }}.txt"
          
          cat > "$REPORT_FILE" <<'REPORT_EOF'
          ==========================================
          PassWall2 Build Report
          ==========================================
          
          Job Name: ${{ github.job }}
          Package Format: ${{ matrix.ver }}
          Build Status: ${{ steps.compile.outputs.status || 'failed' }}
          Build Time: ${{ github.run_id }}
          Workflow Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          === Build Configuration ===
          Branch: ${{ github.ref_name }}
          Version: ${{ needs.job_check.outputs.passwall2_version }}
          Release Type: ${{ needs.job_check.outputs.release_type }}
          Package Format: ${{ github.event.inputs.package_format || 'both' }}
          Cache Enabled: ${{ env.CACHE_ENABLED }}
          
          === Build Environment ===
          Runner OS: ubuntu-latest
          Workflow: ${{ github.workflow }}
          Event: ${{ github.event_name }}
          
          REPORT_EOF
          
          # Add compile status details
          if [ "${{ steps.compile.outputs.status }}" == "success" ]; then
            echo "" >> "$REPORT_FILE"
            echo "=== Build Result: SUCCESS ===" >> "$REPORT_FILE"
            echo "Packages built successfully" >> "$REPORT_FILE"
            ls -lh upload/*.ipk 2>/dev/null | awk '{print $9, "-", $5}' >> "$REPORT_FILE" || true
          else
            echo "" >> "$REPORT_FILE"
            echo "=== Build Result: FAILED ===" >> "$REPORT_FILE"
            echo "Check logs above for errors" >> "$REPORT_FILE"
          fi
          
          echo "" >> "$REPORT_FILE"
          echo "==========================================End of Report==========================================" >> "$REPORT_FILE"
          
          cat "$REPORT_FILE"
          mv "$REPORT_FILE" upload/ 2>/dev/null || mkdir -p build_reports && mv "$REPORT_FILE" build_reports/

      - name: Upload build report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-report-passwall2-${{ matrix.ver }}
          path: |
            build_reports/*.txt
            upload/*.txt
          retention-days: 30

      - name: Upload passwall2 ipks to release
        uses: softprops/action-gh-release@v2
        if: steps.compile.outputs.status == 'success' && steps.should_build_format.outputs.should_build == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{needs.job_check.outputs.passwall2_version}}
          files: ${{ env.FIRMWARE }}/*


  job_auto_compile:
    # CHANGED: Removed prerelease condition - beta also builds all platforms now
    # Platform filtering is done via matrix include/exclude
    if: needs.job_check.outputs.has_update == 'true'
    needs: job_check
    runs-on: ubuntu-latest
    name: build (${{ matrix.ver }}-${{ matrix.platform }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: x86_64
            url_sdk: https://downloads.openwrt.org/snapshots/targets/x86/64/openwrt-sdk-x86-64_gcc-14.3.0_musl.Linux-x86_64.tar.zst
            ver: "ipk"
            priority: high

          - platform: aarch64_generic
            url_sdk: https://downloads.openwrt.org/snapshots/targets/rockchip/armv8/openwrt-sdk-rockchip-armv8_gcc-14.3.0_musl.Linux-x86_64.tar.zst
            ver: "ipk"
            priority: high

          - platform: aarch64_cortex-a53
            url_sdk: https://downloads.openwrt.org/snapshots/targets/mvebu/cortexa53/openwrt-sdk-mvebu-cortexa53_gcc-14.3.0_musl.Linux-x86_64.tar.zst
            ver: "ipk"
            priority: medium

          - platform: aarch64_cortex-a72
            url_sdk: https://downloads.openwrt.org/snapshots/targets/mvebu/cortexa72/openwrt-sdk-mvebu-cortexa72_gcc-14.3.0_musl.Linux-x86_64.tar.zst
            ver: "ipk"
            priority: medium

          - platform: arm_cortex-a5_vfpv4
            url_sdk: https://downloads.openwrt.org/snapshots/targets/at91/sama5/openwrt-sdk-at91-sama5_gcc-14.3.0_musl_eabi.Linux-x86_64.tar.zst
            ver: "ipk"
            priority: low

          - platform: arm_cortex-a7
            url_sdk: https://downloads.openwrt.org/snapshots/targets/mediatek/mt7629/openwrt-sdk-mediatek-mt7629_gcc-14.3.0_musl_eabi.Linux-x86_64.tar.zst
            ver: "ipk"
            priority: medium

          - platform: arm_cortex-a7_neon-vfpv4
            url_sdk: https://downloads.openwrt.org/snapshots/targets/sunxi/cortexa7/openwrt-sdk-sunxi-cortexa7_gcc-14.3.0_musl_eabi.Linux-x86_64.tar.zst
            ver: "ipk"
            priority: medium

          - platform: arm_cortex-a8_vfpv3
            url_sdk: https://downloads.openwrt.org/snapshots/targets/sunxi/cortexa8/openwrt-sdk-sunxi-cortexa8_gcc-14.3.0_musl_eabi.Linux-x86_64.tar.zst
            ver: "ipk"
            priority: low

          - platform: arm_cortex-a9
            url_sdk: https://downloads.openwrt.org/snapshots/targets/bcm53xx/generic/openwrt-sdk-bcm53xx-generic_gcc-14.3.0_musl_eabi.Linux-x86_64.tar.zst
            ver: "ipk"
            priority: high

          - platform: arm_cortex-a9_neon
            url_sdk: https://downloads.openwrt.org/snapshots/targets/zynq/generic/openwrt-sdk-zynq-generic_gcc-14.3.0_musl_eabi.Linux-x86_64.tar.zst
            ver: "ipk"
            priority: medium

          - platform: arm_cortex-a9_vfpv3-d16
            url_sdk: https://downloads.openwrt.org/snapshots/targets/mvebu/cortexa9/openwrt-sdk-mvebu-cortexa9_gcc-14.3.0_musl_eabi.Linux-x86_64.tar.zst
            ver: "ipk"
            priority: medium

          - platform: arm_cortex-a15_neon-vfpv4
            url_sdk: https://downloads.openwrt.org/snapshots/targets/ipq806x/generic/openwrt-sdk-ipq806x-generic_gcc-14.3.0_musl_eabi.Linux-x86_64.tar.zst
            ver: "ipk"
            priority: medium

          - platform: mips_24kc
            url_sdk: https://downloads.openwrt.org/snapshots/targets/ath79/generic/openwrt-sdk-ath79-generic_gcc-14.3.0_musl.Linux-x86_64.tar.zst
            ver: "ipk"
            priority: medium

          - platform: mips_4kec
            url_sdk: https://downloads.openwrt.org/snapshots/targets/realtek/rtl838x/openwrt-sdk-realtek-rtl838x_gcc-14.3.0_musl.Linux-x86_64.tar.zst
            ver: "ipk"
            priority: low

          - platform: mips_mips32
            url_sdk: https://downloads.openwrt.org/snapshots/targets/bcm53xx/generic/openwrt-sdk-bcm53xx-generic_gcc-14.3.0_musl_eabi.Linux-x86_64.tar.zst
            ver: "ipk"
            priority: low

          - platform: mipsel_24kc
            url_sdk: https://downloads.openwrt.org/snapshots/targets/ramips/rt288x/openwrt-sdk-ramips-rt288x_gcc-14.2.0_musl.Linux-x86_64.tar.zst
            ver: "ipk"
            priority: medium

          - platform: mipsel_74kc
            url_sdk: https://downloads.openwrt.org/snapshots/targets/ramips/rt3883/openwrt-sdk-ramips-rt3883_gcc-14.3.0_musl.Linux-x86_64.tar.zst
            ver: "ipk"
            priority: low

          - platform: mipsel_mips32
            url_sdk: https://downloads.openwrt.org/snapshots/targets/bcm47xx/generic/openwrt-sdk-bcm47xx-generic_gcc-14.3.0_musl.Linux-x86_64.tar.zst
            ver: "ipk"
            priority: low

          # APK variants
          - platform: x86_64
            url_sdk: https://downloads.openwrt.org/snapshots/targets/x86/64/openwrt-sdk-x86-64_gcc-14.3.0_musl.Linux-x86_64.tar.zst
            ver: "apk"
            priority: high

          - platform: aarch64_generic
            url_sdk: https://downloads.openwrt.org/snapshots/targets/rockchip/armv8/openwrt-sdk-rockchip-armv8_gcc-14.3.0_musl.Linux-x86_64.tar.zst
            ver: "apk"
            priority: high

          - platform: aarch64_cortex-a53
            url_sdk: https://downloads.openwrt.org/snapshots/targets/mvebu/cortexa53/openwrt-sdk-mvebu-cortexa53_gcc-14.3.0_musl.Linux-x86_64.tar.zst
            ver: "apk"
            priority: medium

          - platform: aarch64_cortex-a72
            url_sdk: https://downloads.openwrt.org/snapshots/targets/mvebu/cortexa72/openwrt-sdk-mvebu-cortexa72_gcc-14.3.0_musl.Linux-x86_64.tar.zst
            ver: "apk"
            priority: medium

          - platform: arm_cortex-a5_vfpv4
            url_sdk: https://downloads.openwrt.org/snapshots/targets/at91/sama5/openwrt-sdk-at91-sama5_gcc-14.3.0_musl_eabi.Linux-x86_64.tar.zst
            ver: "apk"
            priority: low

          - platform: arm_cortex-a7
            url_sdk: https://downloads.openwrt.org/snapshots/targets/mediatek/mt7629/openwrt-sdk-mediatek-mt7629_gcc-14.3.0_musl_eabi.Linux-x86_64.tar.zst
            ver: "apk"
            priority: medium

          - platform: arm_cortex-a7_neon-vfpv4
            url_sdk: https://downloads.openwrt.org/snapshots/targets/sunxi/cortexa7/openwrt-sdk-sunxi-cortexa7_gcc-14.3.0_musl_eabi.Linux-x86_64.tar.zst
            ver: "apk"
            priority: medium

          - platform: arm_cortex-a8_vfpv3
            url_sdk: https://downloads.openwrt.org/snapshots/targets/sunxi/cortexa8/openwrt-sdk-sunxi-cortexa8_gcc-14.3.0_musl_eabi.Linux-x86_64.tar.zst
            ver: "apk"
            priority: low

          - platform: arm_cortex-a9
            url_sdk: https://downloads.openwrt.org/snapshots/targets/bcm53xx/generic/openwrt-sdk-bcm53xx-generic_gcc-14.3.0_musl_eabi.Linux-x86_64.tar.zst
            ver: "apk"
            priority: high

          - platform: arm_cortex-a9_neon
            url_sdk: https://downloads.openwrt.org/snapshots/targets/zynq/generic/openwrt-sdk-zynq-generic_gcc-14.3.0_musl_eabi.Linux-x86_64.tar.zst
            ver: "apk"
            priority: medium

          - platform: arm_cortex-a9_vfpv3-d16
            url_sdk: https://downloads.openwrt.org/snapshots/targets/mvebu/cortexa9/openwrt-sdk-mvebu-cortexa9_gcc-14.3.0_musl_eabi.Linux-x86_64.tar.zst
            ver: "apk"
            priority: medium

          - platform: arm_cortex-a15_neon-vfpv4
            url_sdk: https://downloads.openwrt.org/snapshots/targets/ipq806x/generic/openwrt-sdk-ipq806x-generic_gcc-14.3.0_musl_eabi.Linux-x86_64.tar.zst
            ver: "apk"
            priority: medium

          - platform: mips_24kc
            url_sdk: https://downloads.openwrt.org/snapshots/targets/ath79/generic/openwrt-sdk-ath79-generic_gcc-14.3.0_musl.Linux-x86_64.tar.zst
            ver: "apk"
            priority: medium

          - platform: mips_4kec
            url_sdk: https://downloads.openwrt.org/snapshots/targets/realtek/rtl838x/openwrt-sdk-realtek-rtl838x_gcc-14.3.0_musl.Linux-x86_64.tar.zst
            ver: "apk"
            priority: low

          - platform: mips_mips32
            url_sdk: https://downloads.openwrt.org/snapshots/targets/bcm53xx/generic/openwrt-sdk-bcm53xx-generic_gcc-14.3.0_musl_eabi.Linux-x86_64.tar.zst
            ver: "apk"
            priority: low

          - platform: mipsel_24kc
            url_sdk: https://downloads.openwrt.org/snapshots/targets/ramips/rt288x/openwrt-sdk-ramips-rt288x_gcc-14.2.0_musl.Linux-x86_64.tar.zst
            ver: "apk"
            priority: medium

          - platform: mipsel_74kc
            url_sdk: https://downloads.openwrt.org/snapshots/targets/ramips/rt3883/openwrt-sdk-ramips-rt3883_gcc-14.3.0_musl.Linux-x86_64.tar.zst
            ver: "apk"
            priority: low

          - platform: mipsel_mips32
            url_sdk: https://downloads.openwrt.org/snapshots/targets/bcm47xx/generic/openwrt-sdk-bcm47xx-generic_gcc-14.3.0_musl.Linux-x86_64.tar.zst
            ver: "apk"
            priority: low

    steps:
      - name: Check if should build this format
        id: should_build_format
        run: |
          format_filter="${{ github.event.inputs.package_format }}"
          current_format="${{ matrix.ver }}"
          
          # Default to 'both' if empty (repository_dispatch)
          if [ -z "$format_filter" ]; then
            format_filter="both"
          fi
          
          should_build="true"
          
          # Check if this format should be built
          if [ "$format_filter" == "ipk" ] && [ "$current_format" == "apk" ]; then
            should_build="false"
            echo "Skipping APK - only IPK selected"
          elif [ "$format_filter" == "apk" ] && [ "$current_format" == "ipk" ]; then
            should_build="false"
            echo "Skipping IPK - only APK selected"
          else
            echo "Building $current_format (filter: $format_filter)"
          fi
          
          echo "should_build=$should_build" >> $GITHUB_OUTPUT

      - name: Check if should build this platform
        id: should_build
        run: |
          # Determine if this platform should be built based on build_scope
          build_scope="${{ github.event.inputs.build_scope }}"
          platform="${{ matrix.platform }}"
          priority="${{ matrix.priority }}"
          filter="${{ github.event.inputs.platform_filter }}"
          
          # Default to 'all' if empty
          if [ -z "$build_scope" ]; then
            build_scope="all"
          fi
          
          should_build="false"
          
          case "$build_scope" in
            "all")
              should_build="true"
              ;;
            "popular")
              if [ "$priority" == "high" ]; then
                should_build="true"
              fi
              ;;
            "x86_only")
              if [ "$platform" == "x86_64" ]; then
                should_build="true"
              fi
              ;;
            "custom")
              if echo "$platform" | grep -q "$filter"; then
                should_build="true"
              fi
              ;;
            "none")
              # Explicitly set to false for 'none' scope
              should_build="false"
              ;;
          esac
          
          echo "should_build=$should_build" >> $GITHUB_OUTPUT
          echo "Platform: $platform, Priority: $priority, Build scope: $build_scope, Should build: $should_build"
          
          # If we shouldn't build, skip gracefully (don't exit with error)
          if [ "$should_build" != "true" ]; then
            echo "❌ Skipping this platform based on build_scope"
            echo "This matrix job will be skipped gracefully"
          else
            echo "✅ Will build this platform"
          fi

      - name: Checkout
        if: steps.should_build.outputs.should_build == 'true' && steps.should_build_format.outputs.should_build == 'true'
        uses: actions/checkout@main
        with:
          fetch-depth: 1

      - name: Initialization ${{ matrix.platform }} compile environment
        if: steps.should_build.outputs.should_build == 'true' && steps.should_build_format.outputs.should_build == 'true'
        run: |
          sudo -E rm -rf /usr/share/dotnet /etc/mysql /etc/php /usr/local/lib/android
          echo "Install packages"
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache clang cmake cpio curl device-tree-compiler ecj fastjar flex gawk gettext gcc-multilib \
            g++-multilib git gnutls-dev gperf haveged help2man intltool lib32gcc-s1 libc6-dev-i386 libelf-dev \
            libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses-dev libpython3-dev \
            libreadline-dev libssl-dev libtool libyaml-dev libz-dev lld llvm lrzsz mkisofs msmtp nano \
            ninja-build p7zip p7zip-full patch pkgconf python3 python3-pip python3-ply python3-docutils \
            python3-pyelftools qemu-utils re2c rsync scons squashfs-tools subversion swig texinfo uglifyjs \
            upx-ucl unzip vim wget xmlto xxd zlib1g-dev zstd
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean

      - name: Cache OpenWrt SDK
        if: env.CACHE_ENABLED == 'true' && steps.should_build.outputs.should_build == 'true' && steps.should_build_format.outputs.should_build == 'true'
        id: cache-sdk
        uses: actions/cache@v4
        with:
          path: |
            sdk
            !sdk/dl
            !sdk/tmp
          key: openwrt-sdk-${{ matrix.platform }}-${{ matrix.ver }}-v1
          restore-keys: |
            openwrt-sdk-${{ matrix.platform }}-${{ matrix.ver }}-

      - name: SDK download
        if: steps.cache-sdk.outputs.cache-hit != 'true' && steps.should_build.outputs.should_build == 'true' && steps.should_build_format.outputs.should_build == 'true'
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 15
          max_attempts: 3
          command: |
            wget --continue --progress=dot:giga ${{ matrix.url_sdk }}
            file_name=$(echo ${{matrix.url_sdk}} | awk -F/ '{print $NF}')
            mkdir -p sdk
            if [[ $file_name == *.tar.xz ]]; then
              tar -xJf $file_name -C ./sdk --strip-components=1
            elif [[ $file_name == *.tar.zst ]]; then
              tar --zstd -x -f $file_name -C ./sdk --strip-components=1
            else
              echo "Unsupported file format: $file_name"
              exit 1
            fi

      - name: SSH connection to Actions
        uses: mxschmitt/action-tmate@v3.13
        if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh  != 'false') || contains(github.event.action, 'ssh')

      - name: ${{ matrix.platform }} feeds configuration packages
        if: steps.should_build.outputs.should_build == 'true' && steps.should_build_format.outputs.should_build == 'true'
        run: |
          cd sdk
          ver=${{ matrix.ver }}
          if [ $ver == "ipk" ]; then
            config_apk_line=$(grep -n "USE_APK" Config-build.in | awk -F ':' '{print $1}')
            [ -n "$config_apk_line" ] && sed -n $(expr ${config_apk_line} + 2)p Config-build.in | grep "default y" >/dev/null ; [ $? == 0 ] && sed -i "$(expr ${config_apk_line} + 2)s/y/n/" Config-build.in
          fi

          # Update feeds to github source
          sed -i \
              -e 's|git\.openwrt\.org/feed|github.com/openwrt|g' \
              -e 's|git\.openwrt\.org/project|github.com/openwrt|g' \
              -e 's|git\.openwrt\.org/openwrt|github.com/openwrt|g' \
              "feeds.conf.default"

          # Remove existing passwall feeds to avoid duplicates (from cache)
          sed -i '/passwall_packages/d' feeds.conf.default
          sed -i '/passwall2/d' feeds.conf.default

          # Add passwall feeds at the beginning
          cat > feeds.tmp <<'EOF'
          src-git passwall_packages https://github.com/Openwrt-Passwall/openwrt-passwall-packages.git;main
          src-git passwall2 https://github.com/${{ env.passwall2 }}.git;${{ github.ref_name }}
          EOF
          cat feeds.conf.default >> feeds.tmp
          mv feeds.tmp feeds.conf.default

          echo "=== Final feeds.conf.default ==="
          cat feeds.conf.default
          echo "==================================="


          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Update package version
        if: github.event.inputs.version != '' && steps.should_build.outputs.should_build == 'true' && steps.should_build_format.outputs.should_build == 'true'
        run: |
          cd sdk/feeds/passwall2/luci-app-passwall2
          version="${{ github.event.inputs.version }}"
          echo "Updating package version to: $version"
          
          # Extract version and release
          if [[ "$version" == *-beta ]]; then
            version="${version%-beta}"
          fi
          
          if [[ "$version" == *-* ]]; then
            pkg_version="${version%-*}"
            pkg_release="${version##*-}"
          else
            pkg_version="$version"
            pkg_release="1"
          fi
          
          echo "PKG_VERSION=$pkg_version, PKG_RELEASE=$pkg_release"
          
          # Update Makefile
          sed -i "s/^PKG_VERSION:=.*/PKG_VERSION:=$pkg_version/" Makefile
          sed -i "s/^PKG_RELEASE:=.*/PKG_RELEASE:=$pkg_release/" Makefile
          
          echo "Updated Makefile:"
          grep -E "^PKG_VERSION|^PKG_RELEASE" Makefile

      - name: Apply patches
        if: steps.should_build.outputs.should_build == 'true' && steps.should_build_format.outputs.should_build == 'true'
        run: |
          cd sdk
          #--------------------------------------begin_patches------------------------------------------
          echo "Start applying the patch"

          rm -rf temp_resp
          git clone -b master --depth=1 --single-branch https://github.com/openwrt/packages.git temp_resp

          #--------------------------------------Update Golang------------------------------------------
          echo "update golang version"
          rm -rf feeds/packages/lang/golang
          cp -r temp_resp/lang/golang feeds/packages/lang

          #--------------------------------------Get latest Golang version------------------------------------------
          echo "Attempting to update Golang version..."
          wget https://go.dev/dl/?mode=json -O /tmp/golang.json
          go_latest_version=$(cat /tmp/golang.json | jq -r '.[0].version')
          GO_VERSION_MAJOR_MINOR=$(echo $go_latest_version | sed 's#go##' | awk -F '.' '{print $1 "." $2}')
          GO_VERSION_PATCH=$(echo $go_latest_version | sed 's#go##' | awk -F '.' '{print $3}')
          go_latest_version_hash=$(cat /tmp/golang.json | jq -r '.[0].files[0].sha256')
          
          # Find the correct golang directory with Makefile
          GOLANG_DIR=""
          for dir in $(find feeds/packages/lang/golang -type d -name "golang*" | sort); do
            if [ -f "$dir/Makefile" ]; then
              GOLANG_DIR="$dir"
              break
            fi
          done
          
          if [ -z "$GOLANG_DIR" ]; then
            echo "Warning: Could not find golang directory with Makefile, skipping Golang update"
            echo "Available directories:"
            find feeds/packages/lang/golang -type d | head -10
          else
            echo "Found golang directory with Makefile: $GOLANG_DIR"
            if sed -i -e "s/^GO_VERSION_MAJOR_MINOR:=.*/GO_VERSION_MAJOR_MINOR:=${GO_VERSION_MAJOR_MINOR}/" -e "s/^GO_VERSION_PATCH:=.*/GO_VERSION_PATCH:=${GO_VERSION_PATCH}/" -e "s/^PKG_HASH:=.*/PKG_HASH:=${go_latest_version_hash}/" "$GOLANG_DIR/Makefile"; then
              echo "Successfully updated Golang version in $GOLANG_DIR/Makefile"
            else
              echo "Warning: Failed to update Golang version, but continuing..."
            fi
          fi

          #--------------------------------------Update Rust------------------------------------------
          echo "update rust version"
          rm -rf feeds/packages/lang/rust
          cp -r temp_resp/lang/rust feeds/packages/lang

          #--------------------------------------Clean Temp------------------------------------------
          rm -rf temp_resp

          echo "update patch-kernel.sh"
          git clone -b main --depth=1 --single-branch https://github.com/openwrt/openwrt.git temp_resp
          cp -f temp_resp/scripts/patch-kernel.sh scripts/
          rm -rf temp_resp

          echo "fixed rust host build error"
          sed -i 's/--set=llvm\.download-ci-llvm=false/--set=llvm.download-ci-llvm=true/' feeds/packages/lang/rust/Makefile
          grep -q -- '--ci false \\' feeds/packages/lang/rust/Makefile || sed -i '/x\.py \\/a \        --ci false \\' feeds/packages/lang/rust/Makefile


          echo "Patch application completed"
          #--------------------------------------end_patches--------------------------------------------


          echo "CONFIG_ALL_NONSHARED=n" > .config
          echo "CONFIG_ALL_KMODS=n" >> .config
          echo "CONFIG_ALL=n" >> .config
          echo "CONFIG_AUTOREMOVE=n" >> .config
          echo "CONFIG_SIGNED_PACKAGES=n" >> .config
          echo "CONFIG_LUCI_LANG_fa=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-passwall2=m" >> .config
          echo "CONFIG_PACKAGE_luci-app-passwall2_Iptables_Transparent_Proxy=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-passwall2_Nftables_Transparent_Proxy=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_Haproxy=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_Hysteria=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_IPv6_Nat=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_NaiveProxy=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_Shadowsocks_Libev_Client=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_Shadowsocks_Libev_Server=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_Shadowsocks_Rust_Client=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_Shadowsocks_Rust_Server=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_ShadowsocksR_Libev_Client=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_ShadowsocksR_Libev_Server=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_Simple_Obfs=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_SingBox=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_tuic_client=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_V2ray_Plugin=y" >> .config

          make defconfig
          # AFTER defconfig, forcefully disable all kernel packages (defconfig may re-enable them via deps)
          sed -i '/^CONFIG_PACKAGE_kernel=/s/^CONFIG_\(.*\)=.*/# CONFIG_\1 is not set/' .config
          sed -i '/^CONFIG_PACKAGE_kmod-/s/^CONFIG_\(.*\)=.*/# CONFIG_\1 is not set/' .config

      - name: ${{ matrix.platform }} compile with parallelization
        if: steps.should_build.outputs.should_build == 'true' && steps.should_build_format.outputs.should_build == 'true'
        id: compile
        run: |
          cd sdk
          # Compile packages with better parallelization
          echo "Starting parallel package compilation..."
          
          # Independent packages can be built in parallel
          for package in chinadns-ng geoview; do
            if [ -d "feeds/passwall_packages/$package" ]; then
              echo "Building $package..."
              make package/$package/compile -j$(nproc) V=s || make package/$package/compile -j1 V=s &
            fi
          done
          wait
          
          # Build remaining packages
          for package in ${{ env.package_names }}; do
            if [ -d "feeds/passwall_packages/$package" ] && ! [[ "$package" =~ ^(chinadns-ng|geoview)$ ]]; then
              echo "-----------begin compile $package ---------------"
              make package/$package/compile -j$(nproc) V=s || make package/$package/compile -j1 V=s
              echo "-----------compiled $package ---------------"
            fi
          done

          echo "status=success" >> $GITHUB_OUTPUT

      - name: Organize ${{ matrix.platform }} files
        id: organize
        if: steps.compile.outputs.status == 'success'
        run: |
          cd sdk


          mkdir tmp_upload
          shopt -s nullglob 
          for src_dir in bin/packages/*/{packages,passwall_packages}; do
              [[ -d "$src_dir" ]] || continue

              echo "Scanning: $src_dir"

              for prefix in ${{ env.package_release }}; do
                  for file in "$src_dir"/"$prefix"*; do
                      [[ -f "$file" ]] || continue

                      filename=$(basename "$file")
                      echo "  Found: $filename"
                      cp -r "$file" "tmp_upload/"
                  done
              done
          done

          mkdir upload
          zip -jr upload/passwall_packages_${{ matrix.ver }}_${{ matrix.platform }}.zip tmp_upload/*

          echo "FIRMWARE=$PWD" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Generate build report
        if: always()  # Run even if compile failed
        run: |
          REPORT_FILE="build_report_${{ matrix.platform }}_${{ matrix.ver }}.txt"
          
          cat > "$REPORT_FILE" <<'REPORT_EOF'
          ==========================================
          PassWall2 Platform Build Report
          ==========================================
          
          Job Name: ${{ github.job }}
          Platform: ${{ matrix.platform }}
          Package Format: ${{ matrix.ver }}
          Priority: ${{ matrix.priority }}
          Build Status: ${{ steps.compile.outputs.status || 'failed' }}
          Workflow Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          === Build Configuration ===
          Branch: ${{ github.ref_name }}
          Version: ${{ needs.job_check.outputs.passwall2_version }}
          Release Type: ${{ needs.job_check.outputs.release_type }}
          Build Scope: ${{ github.event.inputs.build_scope || 'all' }}
          Package Format Filter: ${{ github.event.inputs.package_format || 'both' }}
          Cache Enabled: ${{ env.CACHE_ENABLED }}
          SDK URL: ${{ matrix.url_sdk }}
          
          === Build Environment ===
          Runner OS: ubuntu-latest
          Workflow: ${{ github.workflow }}
          Event: ${{ github.event_name }}
          
          REPORT_EOF
          
          # Add platform filtering status
          if [ "${{ steps.should_build.outputs.should_build }}" == "true" ]; then
            echo "" >> "$REPORT_FILE"
            echo "=== Platform Build Status ===" >> "$REPORT_FILE"
            echo "This platform was built according to build_scope filter" >> "$REPORT_FILE"
            
            if [ "${{ steps.compile.outputs.status }}" == "success" ]; then
              echo "" >> "$REPORT_FILE"
              echo "=== Build Result: SUCCESS ===" >> "$REPORT_FILE"
              echo "Packages compiled successfully" >> "$REPORT_FILE"
              echo "" >> "$REPORT_FILE"
              echo "Generated package:" >> "$REPORT_FILE"
              ls -lh upload/*.zip 2>/dev/null | awk '{print $9, "-", $5}' >> "$REPORT_FILE" || echo "No ZIP file found" >> "$REPORT_FILE"
            else
              echo "" >> "$REPORT_FILE"
              echo "=== Build Result: FAILED ===" >> "$REPORT_FILE"
              echo "Check workflow logs for detailed error messages" >> "$REPORT_FILE"
            fi
          else
            echo "" >> "$REPORT_FILE"
            echo "=== Platform Build Status ===" >> "$REPORT_FILE"
            echo "This platform was SKIPPED by build_scope filter" >> "$REPORT_FILE"
            echo "Build scope: ${{ github.event.inputs.build_scope || 'all' }}" >> "$REPORT_FILE"
          fi
          
          echo "" >> "$REPORT_FILE"
          echo "==========================================End of Report==========================================" >> "$REPORT_FILE"
          
          cat "$REPORT_FILE"
          mkdir -p build_reports
          mv "$REPORT_FILE" build_reports/

      - name: Upload build report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-report-${{ matrix.platform }}-${{ matrix.ver }}
          path: build_reports/*.txt
          retention-days: 30

      - name: Upload failed build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.platform }}-${{ matrix.ver }}
          path: |
            sdk/logs/**/*
            sdk/.config
          retention-days: 3

      - name: Generate release info
        id: info
        if: steps.compile.outputs.status == 'success'
        run: |
          cd sdk
          echo "## :mega:Update content" >> release.txt
          echo "![](https://img.shields.io/github/downloads/${{ env.passwall2 }}/${{needs.job_check.outputs.passwall2_version}}/total?style=flat-square)" >> release.txt
          echo "### Passwall2 Info" >> release.txt
          echo "**:minidisc: Passwall2 Version: ${{needs.job_check.outputs.passwall2_version}}**" >> release.txt

          echo "### Packages Version" >> release.txt
          echo "**package name**|**package version**" >> release.txt
          echo "-|-" >> release.txt

          pkgs=$(ls feeds/passwall_packages -I v2ray-geodata | grep -E "$(echo "${{ env.package_names }}" | sed 's/ /|/g')")
          for pkg in $pkgs; do
            version=$(awk -F ':=' '/PKG_VERSION:=/{print $2}' feeds/passwall_packages/$pkg/Makefile | sed 's/\r//g')
            [ -z "${version}" ] && version=$(awk -F ':=' '/PKG_SOURCE_DATE:=/{print $2}' feeds/passwall_packages/$pkg/Makefile | sed 's/\r//g')
            echo "**:ice_cube: $pkg**|**${version}**" >> release.txt
          done
          echo "**:ice_cube: v2ray-geoip**|**$(awk -F ':=' '/GEOIP_VER:=/{print $2}' feeds/passwall_packages/v2ray-geodata/Makefile)**" >> release.txt
          echo "**:ice_cube: v2ray-geosite**|**$(awk -F ':=' '/GEOSITE_VER:=/{print $2}' feeds/passwall_packages/v2ray-geodata/Makefile)**" >> release.txt

          touch release.txt
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Upload firmware to release
        uses: softprops/action-gh-release@v2
        if: steps.info.outputs.status == 'success'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{needs.job_check.outputs.passwall2_version}}
          body_path: ${{ env.FIRMWARE }}/release.txt
          files: ${{ env.FIRMWARE }}/upload/*
